name: Auto KataBump Renew

on:
  schedule:
    # (åŒ—äº¬æ—¶é—´ 12:00)ï¼Œæ¯æœˆçš„ 1, 5, 9... å·è¿è¡Œ
    - cron: '0 4 */4 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿æ›´æ–° README.md
    permissions:
      contents: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. å®‰è£…ç³»ç»Ÿçº§ä¾èµ– (Xvfb å’Œ å­—ä½“)
      # Xvfb ç”¨äºæ¨¡æ‹Ÿæ˜¾ç¤ºå™¨ä»¥ç»•è¿‡ Cloudflare æ£€æµ‹
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb fonts-noto-cjk

      # 4. å®‰è£… Python ä¾èµ–
      - name: Install Python Libraries
        run: |
          # å®‰è£… playwright å’Œ åæ£€æµ‹æ’ä»¶
          pip install playwright==1.52.0 playwright-stealth==1.0.6
          # å®‰è£…æµè§ˆå™¨å†…æ ¸
          playwright install chromium --with-deps

      # 5. è¿è¡Œç»­æœŸè„šæœ¬ (æ ¸å¿ƒæ­¥éª¤)
      - name: Run KataBump Script
        env:
          # ä» GitHub Secrets è¯»å– Cookie é…ç½®
          KATABUMP_COOKIE_NAME: ${{ secrets.KATABUMP_COOKIE_NAME }}   # ä¾‹å¦‚: laravel_session
          KATABUMP_COOKIE_VALUE: ${{ secrets.KATABUMP_COOKIE_VALUE }} # ä½ çš„ Session å€¼
          
          # å…³é”®ç¯å¢ƒé…ç½®ï¼šç¦ç”¨æ— å¤´æ¨¡å¼ + æŒ‡å®šè™šæ‹Ÿæ˜¾ç¤ºå™¨
          HEADLESS: 'false'
          DISPLAY: ':99'
        run: |
          # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºå™¨ (åˆ†è¾¨ç‡è®¾ä¸º 1920x1080)
          Xvfb :99 -screen 0 1920x1080x24 &
          
          # ç­‰å¾… Xvfb å¯åŠ¨
          sleep 2
          
          # è¿è¡Œ Python è„šæœ¬ (ç¡®ä¿ä½ çš„è„šæœ¬æ–‡ä»¶åæ˜¯ katabump.py)
          python katabump.py

      # 6. æäº¤æ›´æ”¹ (æ›´æ–° README.md)
      - name: Commit & Push README
        if: always() # å³ä½¿è„šæœ¬å‡ºé”™ä¹Ÿå°è¯•æäº¤ç»“æœ
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥ README æ˜¯å¦æœ‰å˜åŠ¨
          if [[ -n $(git status -s README.md) ]]; then
            git add README.md
            git commit -m "ğŸ“ Update KataBump status $(date +'%Y-%m-%d')"
            git push
            echo "README updated."
          else
            echo "No changes to README."
          fi

      # 7. ä¸Šä¼ æˆªå›¾ (ä»…å½“å¤±è´¥æ—¶ï¼Œç”¨äºè°ƒè¯•)
      - name: Upload Debug Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: screenshots/
          retention-days: 3
