name: Auto KataBump Renew

on:
  schedule:
    # è®¡åˆ’ä»»åŠ¡ï¼šUTC 04:00 (åŒ—äº¬æ—¶é—´ 12:00)ï¼Œæ¯ 3 å¤©è¿è¡Œä¸€æ¬¡ (1å·, 4å·, 7å·...)
    - cron: '0 4 */3 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘ (ç”¨äºæµ‹è¯•)

jobs:
  renew:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿è„šæœ¬å¯ä»¥æ›´æ–° README.md
    permissions:
      contents: write

    steps:
      # 1. æ£€å‡ºä»£ç ä»“åº“
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. å®‰è£…ç³»ç»Ÿçº§ä¾èµ– (å…³é”®æ­¥éª¤)
      # Xvfb: è™šæ‹Ÿæ˜¾ç¤ºå™¨ï¼Œç”¨äºæ¨¡æ‹Ÿæœ‰å¤´æµè§ˆå™¨ç¯å¢ƒï¼Œç»•è¿‡ Cloudflare å¯¹ Headless çš„æ£€æµ‹
      # fonts-noto-cjk: ä¸­æ—¥éŸ©å­—ä½“ï¼Œé˜²æ­¢ç½‘é¡µä¹±ç 
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb fonts-noto-cjk

      # 4. å®‰è£… Python ä¾èµ–åº“
      - name: Install Python Libraries
        run: |
          # å®‰è£… playwright å’Œ åæ£€æµ‹æ’ä»¶
          pip install playwright==1.52.0 playwright-stealth==1.0.6
          # å®‰è£…æµè§ˆå™¨å†…æ ¸ (Chromium)
          playwright install chromium --with-deps

      # 5. è¿è¡Œç»­æœŸè„šæœ¬ (æ ¸å¿ƒæ­¥éª¤)
      - name: Run KataBump Script
        env:
          # ä» GitHub Secrets è¯»å– Cookie é…ç½®
          # å¿…é¡»é…ç½®: KATABUMP_COOKIE_NAME (é€šå¸¸æ˜¯ katabump_s æˆ– PHPSESSID)
          KATABUMP_COOKIE_NAME: ${{ secrets.KATABUMP_COOKIE_NAME }}
          
          # å¿…é¡»é…ç½®: KATABUMP_COOKIE_VALUE (å¯¹åº”çš„å€¼)
          KATABUMP_COOKIE_VALUE: ${{ secrets.KATABUMP_COOKIE_VALUE }}
          
          # å¿…é¡»é…ç½®: KATABUMP_CF_CLEARANCE (Cloudflare é€šè¡Œè¯ Cookie)
          # è¿™æ˜¯ç»•è¿‡ 5ç§’ç›¾ æ­»å¾ªç¯çš„å…³é”®ï¼
          KATABUMP_CF_CLEARANCE: ${{ secrets.KATABUMP_CF_CLEARANCE }} 
          
          # ç¯å¢ƒé…ç½®ï¼šç¦ç”¨æ— å¤´æ¨¡å¼ + æŒ‡å®šè™šæ‹Ÿæ˜¾ç¤ºå™¨
          HEADLESS: 'false'
          DISPLAY: ':99'
        run: |
          # å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºå™¨ (åˆ†è¾¨ç‡è®¾ä¸º 1920x1080x24)
          Xvfb :99 -screen 0 1920x1080x24 &
          
          # ç­‰å¾… Xvfb å¯åŠ¨
          sleep 3
          
          # è¿è¡Œ Python è„šæœ¬ (ç¡®ä¿ä½ çš„è„šæœ¬æ–‡ä»¶åæ˜¯ katabump.py)
          python katabump.py

      # 6. æäº¤æ›´æ”¹ (æ›´æ–° README.md)
      - name: Commit & Push README
        if: always() # å³ä½¿è„šæœ¬å‡ºé”™ä¹Ÿå°è¯•æäº¤ç»“æœæŠ¥å‘Š
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥ README æ˜¯å¦æœ‰å˜åŠ¨
          if [[ -n $(git status -s README.md) ]]; then
            git add README.md
            git commit -m "ğŸ“ Update KataBump status $(date +'%Y-%m-%d')"
            git push
            echo "README updated."
          else
            echo "No changes to README."
          fi

      # 7. ä¸Šä¼ æˆªå›¾ (ä»…å½“å¤±è´¥æ—¶ï¼Œç”¨äºè°ƒè¯•)
      # å¦‚æœè„šæœ¬è¿è¡Œå¤±è´¥ï¼Œå¯ä»¥åœ¨ Actions é¡µé¢ä¸‹è½½ debug-screenshots.zip æŸ¥çœ‹
      - name: Upload Debug Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: screenshots/
          retention-days: 3
